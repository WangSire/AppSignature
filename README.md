# AppSignature

应用签名原理初探


####1.简单的签名认证原理
App的认证是通过RSA(非对称加密)+应用的Hash值进行数字签名认证!
APP Store 中存有私钥，手机中存放公钥！当我们打包到苹果商店时,实际上App Store获取了应用包的Hash值，然后用私钥加密(也叫数字签名)，当我们下载App时，IPA中包含签名等信息会一起下载到手机上，用手机上的公钥去解密签名，然后得到hash值，手机本身也会去获取应用的hash值，然后对比，如果一样则认为我们的APP没有篡改过，是从官方下载的，然后开始安装! 

但是安装包可以不需要上传到App Store，也可以直接安装到手机上！

此时苹果为了保证系统的安全性，又必须对安装的APP有绝对的控制权 
 -   经过苹果允许才可以安装 
  -  不能被滥用导致非开发APP也能被安装 

为了实现这些需求，iOS签名的复杂度也就开始增加了，苹果这里给出的方案是双层签名！
####2.双向签名
- 在Mac系统中生成非对称加密算法的一对公钥\私钥, 苹果自己有固定的一对公私钥,跟之前App Store原理一样，私钥在苹果后台服务器中（暂时先这么认为），公钥在每个iOS系统中 
- 把公钥M以及一些开发者的信息，传到苹果后台(这个就是CSR文件)，用苹果后台里的私钥A去签名公钥M,这个Hash值是公钥M的Hash。 

- 得到一份文件，其包含了公钥M 以及签名(把公钥M的hash值算出来,一并放到证书中)，把这份数据称为证书(证书就是对公钥M的一个数字签名)，当Mac拿到证书后，会将私钥与证书进行关联(秘钥M就是证书中的密钥) ，或者你也可以认为就是导出后的P12文件
- 在开发时，编译完一个APP后，用本地的私钥M(导出的P12)对这个APP进行签名(就是获取到App的Hash值，用Mac私钥进行加密)，同时把得到的证书也一起打包进 APP 里，安装到手机上。 
-  在安装时，iOS系统取得证书，通过系统内置的公钥A，去验证证书的数字签名是否正确。 
-  验证证书后确保了钥M是苹果认证过的，再用公钥M去验证APP的签名，这里就间接验证了这个APP安装 行为是否经过苹果官方允许。(这里只验证安装行为，不验证APP 是否被改动，也不会去比较HASH值,因为开发阶段 APP 内容总是不断变化的) 

大体流程如图：
![双向签名流程图.png](https://upload-images.jianshu.io/upload_images/4053175-b426891413a8f903.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)


但是虽然经过了上面的过程，已经可以保证开发者的认证，和程序的安全性了。 但是，你要知道iOS的程序，主要渠道是要 通过APP Store才能分发到用户设备的，如果只有上述的过程，那岂不是只要申请了一个证书，就可以安装到所有 iOS设备了? 


苹果为了解决应用滥用的问题，所以苹果又加了两个限制！
 - 第一限制在苹果后台注册过的设备才可以安装!
- 第二限制签名只能针对某一个具体的APP！ 

1. 此时苹果还想控制App里面的iCloud/PUSH/后台运行/调试器附加这些权限，所以苹果把这些权限开关统一称为Entitlements（权限文件）这个文件放在了描述文件文件中.，描述文件是在AppleDevelop网站创建的(在Xcode中填上AppleID它会代办创建)，Xcode运行时会打包进入APP内. 
2. 所以我们使用CSR申请证书时，我们还要申请一个描述文件！在开发时，编译完一个 APP 后，用本地的私钥M对这个APP进行签名，同时把从苹果服务器得到的 Provisioning Profile 文件打包进APP里，因为有了这个描述文件中的一些必要信息。把 APP 安装到手机上后，系统进行验证，避免了滥用等问题！

如下图：
![描述文件.png](https://upload-images.jianshu.io/upload_images/4053175-8203c20884a5c15a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)




其他：
相应指令：security cms -D -i
